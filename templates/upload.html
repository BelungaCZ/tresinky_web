{% extends "base.html" %}

{% block title %}Třešinky Cetechovice - Nahrát fotografie{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Nahrát fotografie</h2>
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            <label for="image" class="form-label">Fotografie</label>
            <div class="input-group">
                <input type="file" class="form-control" id="image" name="image" multiple webkitdirectory directory style="display: none;">
                <button type="button" class="btn btn-primary" id="fileInputButton">Vybrat soubory</button>
                <span class="form-control" id="fileInputLabel">Žádné soubory nebyly vybrány</span>
            </div>
            <div class="form-text" id="fileCount">Můžete nahrát jednotlivé soubory nebo celou složku.</div>
            <div id="fileList" class="mt-2"></div>
        </div>
        <div class="mb-3">
            <label for="album" class="form-label">Album</label>
            {{ form.album(class="form-select") }}
        </div>
        <div class="mb-3">
            <label for="new_album" class="form-label">Nový album</label>
            {{ form.new_album(class="form-control") }}
        </div>
        <div class="mb-3">
            <label for="title" class="form-label">Název</label>
            {{ form.title(class="form-control") }}
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Popis</label>
            {{ form.description(class="form-control") }}
        </div>
        <div class="progress mb-3 d-none" id="uploadProgress">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const progressBar = document.getElementById('uploadProgress');
    const progressBarInner = progressBar.querySelector('.progress-bar');
    const albumSelect = document.getElementById('album');
    const newAlbumInput = document.getElementById('new_album');
    const titleInput = document.getElementById('title');
    const fileList = document.getElementById('fileList');

    // Supported file types
    const supportedTypes = [
        'image/jpeg',
        'image/jpg',
        'image/png',
        'image/webp',
        'image/heic',
        'video/mp4'
    ];

    // Function to check if file is supported
    function isFileSupported(file) {
        // Check if it's a hidden file (starts with .)
        if (file.name.startsWith('.')) {
            return false;
        }
        
        // Check if it's a supported type
        if (supportedTypes.includes(file.type)) {
            return true;
        }
        
        // Check file extension for HEIC files (browsers might not recognize the type)
        const ext = file.name.toLowerCase().split('.').pop();
        if (ext === 'heic') {
            return true;
        }
        
        return false;
    }

    // Функция для определения стратегии загрузки
    function shouldUseSequentialUpload(files) {
        // Если больше 1 поддерживаемого файла - используем поштучную загрузку
        let supportedCount = 0;
        for (let i = 0; i < files.length; i++) {
            if (isFileSupported(files[i])) {
                supportedCount++;
            }
        }
        return supportedCount > 1;
    }

    // Функция поштучной загрузки файлов
    async function uploadFilesSequentially(files, formDataTemplate, progressBarInner, ws) {
        const supportedFiles = [];
        
        // Собираем поддерживаемые файлы
        for (let i = 0; i < files.length; i++) {
            if (isFileSupported(files[i])) {
                supportedFiles.push(files[i]);
            }
        }
        
        let processedFiles = 0;
        let failedFiles = [];
        
        for (let i = 0; i < supportedFiles.length; i++) {
            const file = supportedFiles[i];
            
            try {
                // Создаем FormData для одного файла
                const singleFileFormData = new FormData();
                
                // Копируем все поля кроме файла
                for (let [key, value] of formDataTemplate.entries()) {
                    if (key !== 'image') {
                        singleFileFormData.append(key, value);
                    }
                }
                
                // Добавляем один файл
                singleFileFormData.append('image', file);
                
                // Обновляем прогресс перед загрузкой
                const progressPercent = Math.round((i / supportedFiles.length) * 100);
                progressBarInner.style.width = `${progressPercent}%`;
                progressBarInner.textContent = `${i + 1}/${supportedFiles.length}: ${file.name}`;
                
                // Отправляем файл
                const response = await fetch('/admin/upload', {
                    method: 'POST',
                    body: singleFileFormData
                });
                
                let data;
                const contentType = response.headers.get('content-type');
                
                try {
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Non-JSON response received:', text);
                        throw new Error('Сервер вернул некорректный ответ');
                    }
                    
                    data = await response.json();
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    throw new Error('Ошибка обработки ответа сервера');
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                if (data.success) {
                    processedFiles++;
                    console.log(`Successfully uploaded: ${file.name}`);
                } else {
                    failedFiles.push({name: file.name, error: data.error || 'Unknown error'});
                    console.error(`Failed to upload ${file.name}: ${data.error}`);
                }
                
            } catch (error) {
                failedFiles.push({name: file.name, error: error.message});
                console.error(`Error uploading ${file.name}:`, error);
            }
            
            // Небольшая пауза между загрузками
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Финальный прогресс
        progressBarInner.style.width = '100%';
        progressBarInner.textContent = 'Завершено';
        
        // Небольшая пауза чтобы пользователь увидел завершение прогресс-бара
        await new Promise(resolve => setTimeout(resolve, 500));
        
        return {
            processed: processedFiles,
            failed: failedFiles.length,
            failedDetails: failedFiles,
            total: supportedFiles.length
        };
    }

    // Auto-fill album name and title based on selected directory
    document.getElementById('fileInputButton').addEventListener('click', function() {
        document.getElementById('image').click();
    });

    document.getElementById('image').addEventListener('change', function(e) {
        const files = e.target.files;
        
        // Clear previous file list
        fileList.innerHTML = '';
        
        // Count supported files
        let supportedCount = 0;
        let directoryName = '';
        
        if (files.length > 0) {
            // Get the directory name from the first file
            const path = files[0].webkitRelativePath;
            directoryName = path.split('/')[0];
        }
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (isFileSupported(file)) {
                supportedCount++;
            }
        }
        
        // Update the file input label
        const fileInputLabel = document.getElementById('fileInputLabel');
        if (supportedCount > 0) {
            fileInputLabel.textContent = `${directoryName} (${supportedCount} ${supportedCount === 1 ? 'soubor' : 'soubory'})`;
        } else {
            fileInputLabel.textContent = 'Žádné soubory nebyly vybrány';
        }
        
        // Update the file count text
        const fileCount = document.getElementById('fileCount');
        if (supportedCount > 0) {
            fileCount.textContent = `Vybráno ${supportedCount} ${supportedCount === 1 ? 'soubor' : 'soubory'} k nahrání`;
        } else {
            fileCount.textContent = 'Můžete nahrát jednotlivé soubory nebo celou složku.';
        }
        
        if (supportedCount === 0) {
            fileList.innerHTML = '<div class="alert alert-warning">No supported files found in the selected directory.</div>';
        }
        
        if (files.length > 0) {
            // If no album is selected, use directory name as new album
            if (!albumSelect.value) {
                newAlbumInput.value = directoryName;
            }
            
            // If no title is entered, use directory name as title
            if (!titleInput.value) {
                titleInput.value = directoryName;
            }
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const files = document.getElementById('image').files;
        
        // Проверяем наличие файлов
        if (files.length === 0) {
            alert('Выберите файлы для загрузки.');
            return;
        }
        
        // Создаем базовый FormData с метаданными
        const baseFormData = new FormData();
        
        // Добавляем CSRF токен только если он существует (CSRF защита может быть отключена)
        const csrfTokenElement = document.querySelector('input[name="csrf_token"]');
        if (csrfTokenElement) {
            baseFormData.append('csrf_token', csrfTokenElement.value);
        }
        
        baseFormData.append('album', document.getElementById('album').value);
        baseFormData.append('new_album', document.getElementById('new_album').value);
        baseFormData.append('title', document.getElementById('title').value);
        baseFormData.append('description', document.getElementById('description').value);
        
        // Показываем прогресс-бар
        progressBar.classList.remove('d-none');
        progressBarInner.style.width = '0%';
        
        // Создаем WebSocket соединение
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/upload`);
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'progress') {
                console.log('WebSocket progress update:', data);
            }
        };
        
        ws.onclose = function() {
            console.log('WebSocket connection closed');
        };
        
        // Определяем стратегию загрузки
        if (shouldUseSequentialUpload(files)) {
            // Поштучная загрузка
            console.log('Using sequential upload for', files.length, 'files');
            
            uploadFilesSequentially(files, baseFormData, progressBarInner, ws)
            .then(result => {
                progressBar.classList.add('d-none');
                ws.close();
                
                if (result.failed === 0) {
                    alert(`Все файлы успешно загружены! Обработано: ${result.processed}`);
                    window.location.href = '/admin/gallery';
                } else {
                    let message = `Загрузка завершена. Успешно: ${result.processed}, неудачно: ${result.failed}`;
                    if (result.failedDetails.length > 0) {
                        message += '\n\nОшибки:\n';
                        result.failedDetails.slice(0, 3).forEach(fail => {
                            message += `- ${fail.name}: ${fail.error}\n`;
                        });
                        if (result.failedDetails.length > 3) {
                            message += `... и еще ${result.failedDetails.length - 3} ошибок`;
                        }
                    }
                    alert(message);
                    window.location.href = '/admin/gallery';
                }
            })
            .catch(error => {
                console.error('Sequential upload error:', error);
                progressBar.classList.add('d-none');
                ws.close();
                alert('Критическая ошибка загрузки: ' + error.message);
            });
            
        } else {
            // Обычная загрузка одного файла
            console.log('Using single file upload');
            
            // Добавляем единственный файл
            const file = Array.from(files).find(f => isFileSupported(f));
            if (!file) {
                alert('Не найдены поддерживаемые файлы.');
                progressBar.classList.add('d-none');
                return;
            }
            
            baseFormData.append('image', file);
            
            fetch('/admin/upload', {
                method: 'POST',
                body: baseFormData
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Non-JSON response received:', text);
                        throw new Error('Сервер вернул некорректный ответ');
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                progressBar.classList.add('d-none');
                ws.close();
                
                if (data.success) {
                    // Небольшая пауза для консистентности с поштучной загрузкой
                    setTimeout(() => {
                        alert('Файл успешно загружен!');
                        window.location.href = '/admin/gallery';
                    }, 100);
                } else {
                    alert('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Single file upload error:', error);
                progressBar.classList.add('d-none');
                ws.close();
                alert('Ошибка загрузки: ' + error.message);
            });
        }
    });
});
</script>
{% endblock %} 